# 网络代理问题解决

## 概述
记录在使用 MS-Swift 和相关工具时遇到的网络代理问题及解决方案，包括本地服务访问、评测工具配置等场景。

## 1. 问题现象

### 1.1 本地服务访问被代理拦截

**错误信息**：
```
ERROR: The requested URL could not be retrieved
Connection to 127.0.0.1 failed.
The system returned: (111) Connection refused
Generated by localhost (squid/3.5.20)
```

**问题分析**：
- 本机配置了 http_proxy/https_proxy 环境变量
- 代理服务器（Squid）拦截了本地回环地址的请求
- 即使访问 127.0.0.1:8000 也被当作外部请求处理

### 1.2 评测工具连接失败

**现象**：
- EvalScope 卡住无响应
- 本地 API 服务无法访问
- 评测进程一直等待连接

## 2. 根本原因

### 2.1 环境变量继承问题

**代理设置**：
```bash
# 常见的代理环境变量
export http_proxy=http://proxy.example.com:8080
export https_proxy=http://proxy.example.com:8080
export HTTP_PROXY=http://proxy.example.com:8080
export HTTPS_PROXY=http://proxy.example.com:8080
```

**问题**：
- 这些变量会影响所有 HTTP/HTTPS 请求
- 包括本地回环地址（127.0.0.1, localhost）
- 评测工具和 Python 库会继承这些设置

### 2.2 工具行为差异

**不同工具的处理方式**：
- `curl`：会检查代理设置
- Python requests：自动使用环境变量中的代理
- EvalScope：可能继承代理设置
- 其他评测工具：行为不一致

## 3. 解决方案

### 3.1 临时解决方案（快速测试）

#### 方案 A：禁用代理（推荐用于测试）
```bash
# 只对当前命令禁用代理
curl --noproxy '*' http://127.0.0.1:8000/v1/models

# 或者
curl --noproxy 127.0.0.1,localhost http://127.0.0.1:8000/v1/models
```

#### 方案 B：临时清空代理变量
```bash
# 当前 shell 有效
env -u http_proxy -u https_proxy -u HTTP_PROXY -u HTTPS_PROXY \
  curl http://127.0.0.1:8000/v1/models
```

#### 方案 C：设置 no_proxy
```bash
# 为本地地址设置 no_proxy
NO_PROXY=127.0.0.1,localhost,::1 \
  curl http://127.0.0.1:8000:8000/v1/models
```

### 3.2 永久解决方案

#### 修改 shell 配置文件
编辑 `~/.zshrc` 或 `~/.bashrc`，在末尾添加：

```bash
# 设置本地地址不走代理
export NO_PROXY=127.0.0.1,localhost,::1
export no_proxy=$NO_PROXY

# 如果有固定的本机 IP，也一并加入
export NO_PROXY=$NO_PROXY,172.28.4.55
export no_proxy=$NO_PROXY

# 重新加载配置
source ~/.zshrc
```

#### 验证设置
```bash
# 检查环境变量
echo "NO_PROXY: $NO_PROXY"
echo "no_proxy: $no_proxy"

# 测试本地访问
curl http://127.0.0.1:8000/v1/models
```

### 3.3 针对特定工具的解决方案

#### Python 脚本中的代理设置
```python
import os
import requests

# 方法 1：设置环境变量
os.environ['NO_PROXY'] = '127.0.0.1,localhost'

# 方法 2：在 requests 中禁用代理
proxies = {
    'http': None,
    'https': None
}
response = requests.get('http://127.0.0.1:8000/v1/models', proxies=proxies)
```

#### EvalScope 配置
```bash
# 在运行 EvalScope 前设置环境变量
export NO_PROXY=127.0.0.1,localhost,::1
export no_proxy=$NO_PROXY

# 然后运行评测
evalscope eval \
  --model mh-sft-7b \
  --api-url http://127.0.0.1:8000/v1 \
  --datasets ceval cmmlu \
  --limit 100
```

## 4. 常见场景与解决方案

### 4.1 本地模型服务测试

**场景**：测试 swift deploy 启动的本地服务

**解决方案**：
```bash
# 1. 确认服务状态
ss -ltnp 'sport = :8000' || lsof -i:8000

# 2. 测试服务连通性
curl --noproxy '*' http://127.0.0.1:8000/v1/models

# 3. 测试推理接口
curl --noproxy '*' http://127.0.0.1:8000/v1/chat/completions \
  -H 'Content-Type: application/json' \
  -d '{"model":"mh-sft-7b","messages":[{"role":"user","content":"你好"}]}'
```

### 4.2 评测工具配置

**场景**：使用 EvalScope 或 lm-eval-harness 评测本地服务

**解决方案**：
```bash
# 1. 设置环境变量
export NO_PROXY=127.0.0.1,localhost,::1
export no_proxy=$NO_PROXY

# 2. 运行评测
evalscope eval \
  --model mh-sft-7b \
  --api-url http://127.0.0.1:8000/v1 \
  --eval-type service \
  --datasets ceval cmmlu \
  --limit 100
```

### 4.3 容器化环境

**场景**：在 Docker 容器中访问宿主机服务

**解决方案**：
```bash
# 1. 使用宿主机 IP 而不是 localhost
# 在容器中，127.0.0.1 指向容器本身，不是宿主机

# 2. 使用宿主机网络
docker run --network host your-image

# 3. 或者使用宿主机 IP
curl http://172.17.0.1:8000/v1/models
```

## 5. 预防措施

### 5.1 环境变量管理

**推荐做法**：
```bash
# 在 ~/.zshrc 中设置
export NO_PROXY=127.0.0.1,localhost,::1,172.28.4.55
export no_proxy=$NO_PROXY

# 只在需要时启用代理
export http_proxy=http://proxy.example.com:8080
export https_proxy=http://proxy.example.com:8080
```

### 5.2 服务配置

**本地服务绑定**：
```bash
# 使用 0.0.0.0 绑定所有网卡
swift deploy \
  --model Qwen/Qwen2.5-7B-Instruct \
  --adapters ./output/mh-sft/checkpoint-508 \
  --infer_backend lmdeploy \
  --served_model_name mh-sft-7b \
  --host 0.0.0.0 \
  --port 8000
```

### 5.3 测试脚本

**创建健康检查脚本**：
```bash
#!/bin/bash
# check_service.sh

HOST="${1:-http://127.0.0.1:8000}"

echo "Testing service at $HOST"

# 测试 /models 接口
echo "[1/2] Testing /v1/models"
if curl --noproxy '*' --fail -s "${HOST}/v1/models" > /dev/null; then
    echo "✅ /v1/models endpoint is working"
else
    echo "❌ /v1/models endpoint failed"
    exit 1
fi

# 测试推理接口
echo "[2/2] Testing /v1/chat/completions"
if curl --noproxy '*' --fail -s "${HOST}/v1/chat/completions" \
  -H 'Content-Type: application/json' \
  -d '{"model":"mh-sft-7b","messages":[{"role":"user","content":"test"}]}' > /dev/null; then
    echo "✅ /v1/chat/completions endpoint is working"
else
    echo "❌ /v1/chat/completions endpoint failed"
    exit 1
fi

echo "🎉 Service is healthy!"
```

## 6. 故障排查流程

### 6.1 诊断步骤

1. **检查服务状态**：
   ```bash
   ss -ltnp 'sport = :8000'
   ps aux | grep swift
   ```

2. **检查代理设置**：
   ```bash
   env | grep -i proxy
   echo "NO_PROXY: $NO_PROXY"
   ```

3. **测试网络连通性**：
   ```bash
   curl --noproxy '*' http://127.0.0.1:8000/v1/models
   ```

4. **检查防火墙设置**：
   ```bash
   sudo ufw status
   sudo iptables -L
   ```

### 6.2 常见错误码

- **111 Connection refused**：服务未启动或端口被占用
- **403 Forbidden**：权限问题或服务配置错误
- **404 Not Found**：API 路径错误
- **500 Internal Server Error**：服务内部错误

## 7. 最佳实践总结

### 7.1 环境配置

1. **设置 NO_PROXY**：包含所有本地地址
2. **服务绑定**：使用 0.0.0.0 绑定所有网卡
3. **端口管理**：避免端口冲突

### 7.2 测试流程

1. **服务启动**：确认服务正常运行
2. **连通性测试**：使用 curl 测试基本接口
3. **功能测试**：测试推理接口
4. **评测运行**：在确认服务正常后运行评测

### 7.3 监控与维护

1. **日志记录**：记录服务启动和错误日志
2. **健康检查**：定期检查服务状态
3. **性能监控**：监控响应时间和资源使用

## 8. 总结

网络代理问题是使用 MS-Swift 和相关工具时的常见问题，主要原因是：

1. **环境变量继承**：代理设置影响所有 HTTP 请求
2. **本地地址处理**：代理服务器拦截本地回环地址
3. **工具行为差异**：不同工具对代理的处理方式不同

**解决方案优先级**：
1. 设置 `NO_PROXY` 环境变量（推荐）
2. 使用 `--noproxy` 参数（临时测试）
3. 在代码中禁用代理（Python 脚本）

通过正确的配置和测试流程，可以有效避免代理问题，确保本地服务和评测工具正常工作。

## 9. 变更日志

- 2025-08-20: 初始版本，记录网络代理问题的解决方案
- 2025-08-20: 添加常见场景和最佳实践
