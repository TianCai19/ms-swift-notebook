# 常见错误与解决方案

本文档记录在使用 ms-swift 过程中遇到的常见错误及其解决方案。

## 1. 模型导出错误

### 1.1 `--merge_dtype` 参数不支持

**错误信息**：
```bash
ValueError: remaining_argv: ['--merge_dtype', 'float16']
```

**错误原因**：
`swift export` 命令不支持 `--merge_dtype` 参数。

**错误命令**：
```bash
swift export \
  --ckpt_dir ./output/qwen2.5-7b-sft/checkpoint-43 \
  --merge_lora true \
  --merge_dtype float16 \  # ❌ 这个参数不存在
  --output_dir ./export/qwen-sft-7b
```

**正确命令**：
```bash
swift export \
  --ckpt_dir ./output/qwen2.5-7b-sft/checkpoint-43 \
  --merge_lora true \
  --safe_serialization true \
  --max_shard_size 2GB \
  --output_dir ./export/qwen-sft-7b
```

**支持的导出参数**：
- `--ckpt_dir`: 检查点目录路径
- `--merge_lora`: 是否合并 LoRA 权重
- `--safe_serialization`: 是否使用安全的序列化方式
- `--max_shard_size`: 最大分片大小（如 2GB）
- `--output_dir`: 输出目录

### 1.2 数据类型控制

如果需要控制导出模型的数据类型，可以在训练时使用以下参数：
- `--bf16 true`: 使用 bfloat16 精度（推荐）
- `--fp16 true`: 使用 float16 精度
- `--fp32 true`: 使用 float32 精度（默认）

## 2. 训练相关错误

### 2.1 Flash Attention 相关

**错误信息**：
```bash
RuntimeError: Flash Attention is not available
```

**解决方案**：
```bash
# 安装 flash-attn
pip install flash-attn --no-build-isolation

# 或在训练时使用其他注意力实现
--attn_impl sdpa  # 或 flash_attention_2
```

### 2.2 显存不足 (CUDA OOM)

**错误信息**：
```bash
CUDA out of memory
```

**解决方案**：
1. 降低批次大小：
   ```bash
   --per_device_train_batch_size 4  # 从 8 降到 4
   --gradient_accumulation_steps 8  # 从 4 提高到 8
   ```

2. 降低序列长度：
   ```bash
   --max_length 2048  # 从 3072 降到 2048
   ```

3. 关闭序列打包：
   ```bash
   --packing false
   ```

4. 启用梯度检查点：
   ```bash
   --gradient_checkpointing true
   ```

## 3. 部署相关错误

### 3.1 服务启动失败

**错误信息**：
```bash
Failed to start service
```

**解决方案**：
1. 检查端口占用：
   ```bash
   lsof -i :8000
   ```

2. 检查显存：
   ```bash
   nvidia-smi
   ```

3. 降低会话长度：
   ```bash
   --session-len 2048  # 从 4096 降到 2048
   ```

### 3.2 代理拦截问题

**错误信息**：
```bash
Connection refused
```

**解决方案**：
```bash
# 设置环境变量
export NO_PROXY=127.0.0.1,localhost,::1
export no_proxy=$NO_PROXY

# 或在 curl 中使用
curl --noproxy '*' http://127.0.0.1:8000/v1/models
```

## 4. 评测相关错误

### 4.1 EvalScope 连接失败

**错误信息**：
```bash
Failed to connect to model service
```

**解决方案**：
1. 确认服务已启动：
   ```bash
   curl --noproxy '*' http://127.0.0.1:8000/v1/models
   ```

2. 检查模型名称：
   ```bash
   # 确保 --served_model_name 与评测时使用的名称一致
   --served_model_name qwen2.5-7b-sft
   ```

3. 检查 API 格式：
   ```bash
   evalscope eval \
     --model qwen2.5-7b-sft \
     --api-url http://127.0.0.1:8000/v1 \
     --api-key EMPTY \
     --eval-type service
   ```

## 5. 环境相关错误

### 5.1 中文显示问题

**错误现象**：
终端显示乱码或无法正确显示中文。

**解决方案**：
```bash
# 设置 locale
export LANG=zh_CN.UTF-8
export LC_ALL=zh_CN.UTF-8

# 或在系统级别设置
sudo locale-gen zh_CN.UTF-8
sudo update-locale LANG=zh_CN.UTF-8
```

### 5.2 Python 包版本冲突

**错误信息**：
```bash
ImportError: cannot import name 'xxx'
```

**解决方案**：
1. 创建新的虚拟环境：
   ```bash
   conda create -n swift_llm python=3.10
   conda activate swift_llm
   ```

2. 安装指定版本：
   ```bash
   pip install 'ms-swift[all]'==0.8.0
   ```

## 6. 调试技巧

### 6.1 参数验证
在运行命令前，可以先检查参数：
```bash
swift export --help
swift sft --help
swift deploy --help
```

### 6.2 日志级别
增加日志详细程度：
```bash
export SWIFT_LOG_LEVEL=DEBUG
```

### 6.3 逐步测试
1. 先用小数据集测试
2. 逐步增加批次大小
3. 监控显存使用情况

## 7. 预防措施

### 7.1 参数检查清单
- [ ] 确认所有参数名称正确
- [ ] 检查参数值是否合理
- [ ] 验证路径是否存在
- [ ] 确认环境变量已设置

### 7.2 备份策略
- 定期保存检查点
- 备份配置文件
- 记录成功的命令组合

---

**注意**: 如果遇到本文档未覆盖的错误，请：
1. 检查错误日志的完整信息
2. 搜索相关 GitHub Issues
3. 在社区中寻求帮助
4. 将新的错误和解决方案添加到本文档中
